name: Deploy Linkrew

on:
  push:
    branches:
      - main # main 브랜치 푸시 시 자동 배포

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 레포지토리 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Node.js 설치
      - uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ 의존성 설치 + 빌드
      - run: |
          npm ci
          npm run build

      # 4️⃣ SSH 키 로딩 (GitHub Secret)
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5️⃣ SSH config 작성 (Bastion + 내부 서버)
      - run: |
          mkdir -p ~/.ssh
          echo "
          Host bastion
            HostName undertopia.com
            Port 54222
            User guest

          Host linkrew-web-dev
            HostName 192.168.0.79
            User ubuntu
            ProxyJump bastion
          " > ~/.ssh/config
          chmod 600 ~/.ssh/config

      # 6️⃣ known_hosts 등록
      - run: |
          ssh-keyscan -p 54222 undertopia.com >> ~/.ssh/known_hosts || true
          ssh-keyscan 192.168.0.79 >> ~/.ssh/known_hosts || true

      # 7️⃣ 서버 temp-dist 초기화
      - run: |
          ssh -F ~/.ssh/config -o StrictHostKeyChecking=no linkrew-web-dev "rm -rf ~/temp-dist && mkdir -p ~/temp-dist"

      # 8️⃣ dist 파일 전송
      - run: |
          scp -F ~/.ssh/config -r ./dist/* linkrew-web-dev:~/temp-dist/

      # 9️⃣ 서버 내부 배포
      - run: |
          ssh -F ~/.ssh/config -o StrictHostKeyChecking=no linkrew-web-dev << 'EOF'
            APP_DIR="/home/ubuntu/linkrew"
            TEMP_DIR="/home/ubuntu/temp-dist"

            echo " 업로드 파일 확인"
            ls -la $TEMP_DIR/

            echo "기존 앱 파일 삭제"
            sudo /bin/rm -rf $APP_DIR/*

            echo "새 파일 복사"
            sudo /bin/cp -r $TEMP_DIR/* $APP_DIR/

            echo "권한 설정"
            sudo /bin/chown -R ubuntu:ubuntu $APP_DIR/
            sudo /bin/chmod -R 755 $APP_DIR/

            echo "배포된 파일 확인"
            ls -la $APP_DIR/

            echo "Nginx 재시작"
            sudo /usr/bin/systemctl reload nginx

            echo "배포 완료!"
          EOF
